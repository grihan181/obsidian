Архитектура шардированного кластера в **PostgreSQL** не является встроенной функцией, как, например, в некоторых других СУБД (MongoDB, Cassandra). Для реализации шардирования в PostgreSQL часто используются сторонние решения или расширения, такие как **Citus**, **pg_shard** или другие инструменты распределения данных. Эти решения позволяют масштабировать базу данных горизонтально, распределяя данные между несколькими узлами (серверными экземплярами PostgreSQL), которые работают вместе в виде шардированного кластера.

### Основные компоненты архитектуры шардированного кластера PostgreSQL:

1. **Шарды (Shards)**:
    
    - Каждый шард представляет собой отдельную базу данных или набор таблиц, которые хранятся на разных серверах (узлах).
    - Данные делятся на сегменты по определённому ключу (обычно это ID пользователя, даты и т.д.), и каждый сегмент записывается на отдельный шард.
    - Шарды распределяют данные равномерно между узлами для баланса нагрузки.
2. **Узел-мастер (Coordinator/Master Node)**:
    
    - Этот узел выполняет роль координации запросов между клиентами и шардами.
    - Когда клиент делает запрос (например, SELECT, INSERT), мастер узел анализирует запрос и направляет его на нужный шард, где хранятся данные.
    - Мастер-узел не содержит данные, он лишь управляет распределением запросов.
3. **Шард-узлы (Shard Nodes или Worker Nodes)**:
    
    - Эти узлы фактически хранят данные. Каждый шард-узел содержит определенную часть общего набора данных.
    - Шард-узлы принимают запросы от мастера и выполняют операции над данными, а затем возвращают результат обратно мастеру.
    - Узлы-шарды могут быть организованы в виде репликации (для отказоустойчивости) с ведущими и ведомыми репликами.
4. **Репликация и отказоустойчивость (Replication and Failover)**:
    
    - Для обеспечения отказоустойчивости шардированные узлы часто используют репликацию данных. Каждый узел-шард может иметь одну или несколько реплик, которые хранят копии данных.
    - При сбое одного узла запросы перенаправляются на реплику.
    - Репликация может использовать встроенные механизмы PostgreSQL, такие как **Streaming Replication**, или специализированные инструменты.
5. **Система балансировки нагрузки (Load Balancer)**:
    
    - Балансировщик нагрузки распределяет запросы от клиентов между узлами-мастерами или между шардами, чтобы оптимизировать производительность.
    - В шардированной архитектуре это важный компонент для распределения нагрузки по всем узлам и предотвращения перегрузки одного из них.
6. **Каталог метаданных (Metadata)**:
    
    - В некоторых системах шардирования (например, Citus) существует отдельная база данных для хранения информации о том, какие данные хранятся на каких шардах.
    - Каталог метаданных помогает отслеживать, на каких узлах находятся фрагменты данных, и облегчает маршрутизацию запросов.

### Пример архитектуры с использованием Citus (расширения для PostgreSQL):

- **Coordinator**: Один экземпляр PostgreSQL, который действует как мастер-узел (координатор). Клиенты подключаются к нему для отправки запросов.
- **Worker Nodes**: Несколько узлов PostgreSQL, каждый из которых хранит отдельные шарды. Узлы могут работать независимо и обрабатывать данные локально.
- **Шардирование**: Данные разбиваются по логическим ключам (например, ID или дате) и равномерно распределяются между worker nodes.
- **Репликация**: Для отказоустойчивости worker nodes могут иметь резервные копии через механизм репликации.
- **Запросы**: Координатор принимает запросы от клиентов, анализирует их, решает, на какой шард отправить запрос, и выполняет операции с данными на соответствующих worker nodes.